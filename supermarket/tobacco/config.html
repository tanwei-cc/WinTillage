--- 
title: 烟草订购探测程序配置
---

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="renderer" content="webkit|ie-comp|ie-stand" />
    <meta name="viewport" content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ page.title }}</title>
    <link rel="shortcut icon" href="favicon.ico">
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <style>
        pre {
            white-space: pre-line;
        }

        #btnBack {
            display: none;
        }
        
        #code {
            display: none;
            height: 400px;
        }
        
        tr .btn-danger {
            display: inline-block;
        }
        
        tr .btn-cancel {
            display: none;
        }
        
        tr.danger .btn-danger {
            display: none;
        }
        
        tr.danger .btn-cancel {
            display: inline-block;
        }
        
        tr.danger input {
            display: none;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand">
                    烟草订购探测程序配置
                </a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <!-- <li><a></a></li> -->
                </ul>
            </div>
        </div>
    </nav>

    <div class="container theme-showcase">
        <a id="btnGen" class="btn btn-default">生成代码</a>
        <a id="btnBack" class="btn btn-default">返回</a><br><br>
        <div style="max-height: 500px;overflow: auto;">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th style="width:80px">行号</th>
                        <th>商品名称</th>
                        <!-- <th>商品代码</th> -->
                        <th>需求数量<span class="text-muted">(如果可定数量不够则自动减少)</span></th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <textarea id="code" class="form-control"></textarea>
    </div>
    <pre id="codeTpl" class="hide">
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://tanwei-cc.github.io/WinTillage/supermarket/tobacco/detector.js?" + (+new Date);
    window.detectConfig={detectConfig};
    document.getElementsByTagName("head")[0].appendChild(script);
</pre>
    <script>
        $(function() {
            var key = 'detectConfig';
            var tableEl = $('.table');
            var tbodyEl = tableEl.find('>tbody');
            var btnGenEl = $('#btnGen');
            var btnBackEl = $('#btnBack');
            var codeEl = $('#code');
            var codeTpl = $('#codeTpl').html();
            var getConfig = function() {
                var config = localStorage[key];
                if (config) {
                    try {
                        return JSON.parse(config);
                    } catch (ex) {}
                }
                return {};
            };
            var setConfig = function() {
                var config = {};
                var excludes = [];
                var includes = [];

                tbodyEl.find('tr').each(function() {
                    var el = $(this);
                    var num = parseInt(el.find('input').val());
                    var code = '' + el.data('code');

                    if (el.is('.danger')) {
                        excludes.push(code);
                    } else if (!isNaN(num)) {
                        includes.push({
                            name: code,
                            num: num
                        });
                    }
                });

                config.excludes = excludes;
                config.includes = includes;
                config = JSON.stringify(config);
                localStorage[key] = config;

                return config;
            };
            var render = function() {
                var config = getConfig();
                var excludes = config.excludes || [];
                var includes = config.includes || [];

                $.get('data.json', function(res) {
                    var html = [];

                    $.each(res, function(index) {
                        var name = this.productDesc;
                        var code = this.productCode;
                        var className = '';
                        var includeItem = includes.find(function(item) {
                            return item.name === code;
                        });
                        var num = includeItem ? includeItem.num : '';

                        if (excludes.indexOf(code) > -1) {
                            className = 'danger';
                        }

                        html.push([
                            '<tr data-code="' + code + '" class="' + className + '">',
                            '<td>' + (index + 1) + '</td>',
                            '<td>' + name + '</td>',
                            // '<td>' + code + '</td>',
                            '<td><input type="number" value="' + num + '"/></td>',
                            '<td><a class="btn btn-danger btn-sm">排除</a><a class="btn btn-cancel btn-default btn-sm">取消</a></td>',
                            '</tr>'
                        ].join(''));
                    });

                    tbodyEl.html(html.join(''));
                });
            };

            render();

            btnGenEl.click(function() {
                var config = setConfig();

                codeEl.val(codeTpl.replace(/\{detectConfig\}/, config));
                codeEl.show();
                codeEl.select();
                try {
                    document.execCommand('copy');
                    setTimeout(function(){
                        alert('代码已复制，ctrl+v即可黏贴');
                    }, 100);
                } catch (e) { }
                tableEl.hide();
                btnGenEl.hide();
                btnBackEl.show();
            });

            btnBackEl.click(function() {
                tableEl.show();
                codeEl.hide();
                btnGenEl.show();
                btnBackEl.hide();
            });

            tbodyEl.on('click', '.btn-danger', function() {
                $(this).parents('tr').addClass('danger');
                setConfig();
            }).on('click', '.btn-cancel', function() {
                $(this).parents('tr').removeClass('danger');
                setConfig();
            }).on('input', 'input', function(){
                setConfig();
            });
        });
    </script>
</body>

</html>